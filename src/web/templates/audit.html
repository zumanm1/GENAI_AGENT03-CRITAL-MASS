{% extends "base.html" %}

{% block title %}Configuration Audit - {{ super() }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Configuration Validation & Dry-Run</h1>
    <p class="text-muted mb-4">
        Upload a network configuration file or paste it into the text area below. The system will validate its syntax
        and provide a dry-run analysis of the changes it would perform.
    </p>

    <div class="card">
        <div class="card-body">
            <form id="audit-form">
                <div class="mb-3">
                    <label for="device-type" class="form-label"><strong>Device Operating System</strong></label>
                    <select class="form-select" id="device-type" name="device_type" required>
                        <option value="cisco_ios">Cisco IOS</option>
                        <option value="juniper_junos">Juniper Junos</option>
                        <option value="arista_eos">Arista EOS</option>
                        <option value="cisco_nxos">Cisco NX-OS</option>
                        <option value="cisco_xr">Cisco IOS-XR</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="config-upload" class="form-label"><strong>Upload Configuration File</strong></label>
                    <input class="form-control" type="file" id="config-upload" accept=".txt,.conf,.cfg">
                </div>

                <div class="mb-3">
                    <label for="config-text" class="form-label"><strong>Or Paste Configuration</strong></label>
                    <textarea class="form-control" id="config-text" name="config_text" rows="15" placeholder="e.g.,
interface GigabitEthernet0/1
 ip address 192.168.1.1 255.255.255.0
 no shutdown
!"></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100">
                    <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Validate Configuration
                </button>
            </form>
        </div>
    </div>

    <div id="results-container" class="mt-5" style="display: none;">
        <h2 class="mb-3">Validation Results</h2>
        <div class="card">
            <div class="card-body">
                <pre id="results-output" class="p-3 bg-light rounded"><code></code></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('audit-form');
    const uploadInput = document.getElementById('config-upload');
    const textInput = document.getElementById('config-text');
    const resultsContainer = document.getElementById('results-container');
    const resultsOutput = document.getElementById('results-output').querySelector('code');
    const spinner = document.getElementById('spinner');
    const submitButton = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const deviceType = document.getElementById('device-type').value;
        let configContent = textInput.value;

        if (uploadInput.files.length > 0) {
            const file = uploadInput.files[0];
            configContent = await file.text();
        }

        if (!configContent.trim()) {
            alert('Please upload a file or paste a configuration.');
            return;
        }

        submitButton.disabled = true;
        spinner.classList.remove('d-none');
        resultsContainer.style.display = 'none';

        try {
            const response = await fetch('/api/audit/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    device_type: deviceType,
                    config_content: configContent
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            resultsOutput.textContent = JSON.stringify(result, null, 2);
            resultsContainer.style.display = 'block';

        } catch (error) {
            console.error('Validation error:', error);
            resultsOutput.textContent = `An error occurred: ${error.message}`;
            resultsContainer.style.display = 'block';
        } finally {
            submitButton.disabled = false;
            spinner.classList.add('d-none');
        }
    });
});
</script>
{% endblock %} 