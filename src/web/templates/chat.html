{% extends "base.html" %}

{% block title %}AI Chat - Network Automation AI Agent{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .assistant-message {
        background-color: #28a745;
        color: white;
        margin-right: auto;
    }
    
    .message-input {
        border-radius: 25px;
        padding: 12px 20px;
    }
    
    .send-btn {
        border-radius: 25px;
        padding: 12px 25px;
    }
    
    .typing-indicator {
        display: none;
        padding: 10px;
        font-style: italic;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid chat-container">
    <div class="row h-100">
        <!-- Sidebar for AI Model Selection -->
        <div class="col-md-3 sidebar">
            <h5 class="mt-3 mb-3">AI Model</h5>
            <div id="model-list" class="list-group">
                <!-- AI models will be dynamically loaded here -->
                        </div>
            <hr>
            <div class="sidebar-footer">
                <small>Current Model:</small>
                <strong id="current-model-display">N/A</strong>
                    </div>
                </div>

        <!-- Main Chat Area -->
        <div class="col-md-9 chat-area">
            <div class="chat-header">
                <h4 class="mb-0">AI Network Assistant</h4>
                            </div>
            <div id="chat-messages" class="chat-messages p-3">
                {% for message in history %}
                    <div class="message {{ 'user-message' if message.message_type == 'user' else 'assistant-message' }}">
                        <div class="message-content">{{ message.content }}</div>
                    </div>
                {% endfor %}
            </div>
            <div id="attached-file-display" class="p-2 border-top" style="display: none;">
                <!-- Attached file info will be shown here -->
                    </div>
            <div class="chat-input-section">
                <form id="chat-form" class="d-flex p-3 border-top">
                    <!-- Hidden file input for RAG -->
                    <input type="file" id="file-input" style="display: none;" accept=".txt,.pdf,.csv,.xlsx">
                    
                    <!-- File attachment button -->
                    <button type="button" class="btn btn-secondary me-2" id="attach-file-button" title="Attach a file for context">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    
                    <!-- Message input field -->
                    <input type="text" id="message-input" class="form-control me-2" placeholder="Ask about network configs, devices, or use an uploaded file...">
                    
                    <!-- Send button -->
                    <button type="submit" id="send-button" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
            </div>
        </div>
    </div>
</div>

<script>
// =============================================================================
// DOM Element References and State Initialization
// =============================================================================
document.addEventListener('DOMContentLoaded', function() {
    // --- Element References ---
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const modelList = document.getElementById('model-list');
    const currentModelDisplay = document.getElementById('current-model-display');
    const attachFileButton = document.getElementById('attach-file-button');
    const fileInput = document.getElementById('file-input');
    const attachedFileDisplay = document.getElementById('attached-file-display');

    // --- State Variables ---
    // The unique session ID is rendered by the Flask template.
    // This is crucial for keeping this user's RAG context separate from others.
    const sessionId = '{{ session_id }}';
    let currentModel = ''; // The name of the currently selected Ollama model.
    let attachedFileId = null; // The ID of the file uploaded for RAG context.

    // =============================================================================
    // Core Functions
    // =============================================================================

    /**
     * Appends a message to the chat window.
     * @param {string} text - The message content.
     * @param {boolean} isUser - True if the message is from the user, false if from the AI.
     * @param {boolean} isSystem - True for system messages (e.g., file upload status).
     */
    function addMessage(text, isUser, isSystem = false) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', isUser ? 'user-message' : 'ai-message');
        if (isSystem) {
            messageElement.classList.add('system-message');
        }
        
        // Sanitize text to prevent basic HTML injection.
        const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        messageElement.innerHTML = `<div class="message-content">${sanitizedText}</div>`;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to the latest message.
    }

    /**
     * Sends the user's message to the backend API.
     * Handles prepending RAG context if a file has been uploaded.
     * @param {string} content - The text message from the user.
     */
    function sendMessage(content) {
        // Disable form to prevent multiple submissions.
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Display the user's message immediately in the UI.
        addMessage(content, true);
        
        const payload = {
            message: content,
            session_id: sessionId,
            model: currentModel,
            stream: true
        };

        const eventSource = new EventSource(`/api/chat/message?payload=${encodeURIComponent(JSON.stringify(payload))}`);
        let assistantMessageElement = null;

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.error) {
                addMessage(`Error: ${data.error}`, false, true);
                eventSource.close();
                return;
            }

            if (!assistantMessageElement) {
                assistantMessageElement = addMessage('', false);
            }

            assistantMessageElement.querySelector('.message-content').innerHTML += data.response;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        eventSource.onerror = function(err) {
            console.error("EventSource failed:", err);
            addMessage('Error: Could not connect to the server for streaming.', false, true);
            eventSource.close();
            // Re-enable the form.
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        };
    }

    /**
     * Fetches the list of available Ollama models from the backend and populates the sidebar.
     */
    function loadModels() {
        fetch('/api/ollama/models')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                modelList.innerHTML = ''; // Clear existing list.
                currentModel = data.current_model;
                currentModelDisplay.textContent = currentModel;
                
                // Create a button for each available model.
                data.models.forEach(model => {
                    const modelButton = document.createElement('a');
                    modelButton.href = '#';
                    modelButton.classList.add('list-group-item', 'list-group-item-action');
                    if (model.name === currentModel) {
                        modelButton.classList.add('active');
                    }
                    modelButton.textContent = model.name;
                    modelButton.dataset.modelName = model.name;
                    modelList.appendChild(modelButton);
                });
            })
            .catch(error => {
                console.error('Error loading models:', error);
                const errorElement = document.createElement('div');
                errorElement.className = 'list-group-item text-danger';
                errorElement.textContent = 'Could not load models. Is Ollama running?';
                modelList.appendChild(errorElement);
            });
    }

    /**
     * Handles the file upload process for RAG.
     * @param {File} file - The file selected by the user.
     */
    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        addMessage(`Uploading file: ${file.name}...`, false, true);

        // Send the file to the dedicated upload endpoint.
        // The session ID is sent as a header to link the file to this user's session.
        fetch('/api/chat/upload', {
            method: 'POST',
            headers: {
                'X-Session-ID': sessionId
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                attachedFileId = data.file_id;
                addMessage(`File "${file.name}" is now ready for context.`, false, true);
                // Display the name of the attached file in the UI.
                attachedFileDisplay.innerHTML = `<small class="text-muted p-2">Context: <strong>${file.name}</strong></small>`;
                attachedFileDisplay.style.display = 'block';
            } else {
                throw new Error(data.error || 'Unknown error during file upload.');
            }
        })
        .catch(error => {
            console.error('Error uploading file:', error);
            addMessage(`Error uploading file: ${error.message}`, false, true);
            attachedFileDisplay.style.display = 'none';
        });
    }

    function loadHistory() {
        fetch(`/api/chat/history/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                chatMessages.innerHTML = ''; // Clear existing messages.
                
                data.forEach(message => {
                    addMessage(message.content, message.message_type === 'user');
                });
            })
            .catch(error => {
                console.error('Error loading chat history:', error);
                addMessage('Error: Could not load chat history.', false, true);
            });
    }

    // =============================================================================
    // Event Listeners
    // =============================================================================

    // --- Handle Chat Form Submission ---
    chatForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const messageText = messageInput.value.trim();
        if (messageText) {
            sendMessage(messageText);
            messageInput.value = ''; // Clear input field.
        }
    });

    // --- Handle Model Selection ---
    modelList.addEventListener('click', function(event) {
        event.preventDefault();
        const target = event.target;
        if (target && target.classList.contains('list-group-item')) {
            const modelName = target.dataset.modelName;
            if (modelName && modelName !== currentModel) {
                // Update state and UI
                currentModel = modelName;
                currentModelDisplay.textContent = modelName;
                
                // Remove active class from all buttons and add to the clicked one.
                document.querySelectorAll('#model-list .list-group-item').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
        
                // Inform the user of the model switch.
                addMessage(`Switched to model: ${modelName}`, false, true);
        
                // (Optional) Inform the backend. This is currently a mock endpoint.
                fetch('/api/ollama/model', {
            method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName })
                });
            }
        }
    });

    // --- Handle File Attachment ---
    attachFileButton.addEventListener('click', function() {
        fileInput.click(); // Trigger the hidden file input dialog.
    });

    fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            uploadFile(file);
        }
        // Reset the input so the user can upload the same file again if needed.
        fileInput.value = '';
    });

    // Check for a command from the library
    const commandToUse = localStorage.getItem('command_to_use');
    if (commandToUse) {
        messageInput.value = commandToUse;
        localStorage.removeItem('command_to_use');
    }

    // =============================================================================
    // Initial Page Load Actions
    // =============================================================================
    addMessage("Hello! I'm your Network Automation AI Assistant. I can help you with network configuration, troubleshooting, and automation tasks. What would you like to know?", false);
    loadModels();
    loadHistory();
});
</script>
{% endblock %} 